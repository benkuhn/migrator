- test: Basic index
  before: |
    CREATE TABLE users (u_id SERIAL PRIMARY KEY, mobile TEXT NOT NULL);
  after: |
    CREATE TABLE users (u_id SERIAL PRIMARY KEY, mobile TEXT NOT NULL);
    CREATE INDEX users_mobile ON users (mobile);
  migration:
    message: "a migration"
    pre_deploy:
      - create_index:
          name: users_mobile
          table: public.users
          expr: mobile
  reverse:
    message: "a migration"
    post_deploy:
      - drop_index:
          name: users_mobile
          table: public.users
          expr: mobile
- test: Partial unique index
  before: |
    CREATE TABLE users (u_id SERIAL PRIMARY KEY, mobile TEXT NOT NULL);
  after: |
    CREATE TABLE users (u_id SERIAL PRIMARY KEY, mobile TEXT NOT NULL);
    CREATE UNIQUE INDEX users_mobile ON users (mobile) WHERE u_id > 0;
  migration:
    message: "a migration"
    pre_deploy:
      - create_index: &index
          unique: true
          name: users_mobile
          table: public.users
          expr: mobile
          where: (u_id > 0)
  reverse:
    message: "a migration"
    post_deploy:
      - drop_index:
          <<: *index
- test: CHECK constraint
  before: |
    CREATE TABLE users (u_id SERIAL PRIMARY KEY, mobile TEXT NOT NULL);
  after: |
    CREATE TABLE users (
      u_id SERIAL PRIMARY KEY,
      mobile TEXT NOT NULL
      CONSTRAINT users_check CHECK (mobile LIKE '+%')
    );
  migration:
    message: "a migration"
    pre_deploy:
      - add_check_constraint: &check-constraint
          name: users_check
          table: public.users
          expr: (mobile ~~ '+%'::text)
  reverse:
    message: "a migration"
    post_deploy:
      - drop_check_constraint:
          <<: *check-constraint
